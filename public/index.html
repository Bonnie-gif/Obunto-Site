<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEWTON OS // TSC GATEWAY</title>
    <style>
        :root { --bg: #89937a; --ink: #2b3323; --paper: #c8d1c0; --border: #2b3323; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background: #0f0f0f; height: 100vh; font-family: 'Courier New', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 9999; }
        .full-screen { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); position: relative; padding: 20px; }
        .full-screen.active { display: flex; }
        .center-flex { justify-content: center; align-items: center; }

        @keyframes ink-spread { 0% { clip-path: circle(0% at 50% 0%); opacity: 0; } 100% { clip-path: circle(150% at 50% 0%); opacity: 1; } }
        .window.opening { animation: ink-spread 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes handwrite { 0% { opacity: 0; transform: translateX(-5px); } 100% { opacity: 1; transform: translateX(0); } }
        input { animation: handwrite 0.3s ease-out; }

        .window { background: var(--paper); border: 2px solid var(--border); box-shadow: 8px 8px 0 rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .win-header { background: var(--border); color: var(--bg); padding: 5px 10px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 2px solid var(--border); }
        .win-body { padding: 15px; overflow-y: auto; color: var(--ink); }
        input, select, textarea { background: transparent; border: none; border-bottom: 2px solid var(--border); width: 100%; padding: 5px; font-family: inherit; font-weight: bold; outline: none; margin-bottom: 10px; color: var(--ink); }
        input:focus { border-bottom-width: 3px; }
        .os-btn { background: var(--paper); border: 2px solid var(--border); padding: 8px; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 0 var(--border); color: var(--ink); margin-right: 5px; text-transform: uppercase; font-size: 11px; }
        .os-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 var(--border); }
        .os-btn.danger { border-color: #550000; color: #550000; }
        .os-btn.small { padding: 2px 6px; box-shadow: 2px 2px 0 var(--border); }
        .hidden { display: none !important; }

        /* ADMIN PANEL LAYOUT */
        .adm-container { display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; height: 100%; }
        .adm-panel { background: var(--paper); border: 2px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .adm-title { background: var(--border); color: var(--bg); padding: 5px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        .adm-content { padding: 10px; overflow-y: auto; flex: 1; font-size: 11px; }

        .user-row { padding: 8px; border-bottom: 1px dashed var(--border); display: flex; justify-content: space-between; align-items: center; }
        .user-row:hover { background: rgba(0,0,0,0.05); }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; border: 1px solid var(--ink); }
        .online { background: #0f0; } .offline { background: transparent; } .frozen { background: #f00; }

        /* MOOD SELECTOR GRID */
        .mood-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px; margin-bottom: 10px; border: 1px solid var(--border); padding: 5px; height: 100px; overflow-y: auto; }
        .mood-item { width: 100%; aspect-ratio: 1; border: 1px solid var(--border); cursor: pointer; display: flex; justify-content: center; align-items: center; overflow: hidden; opacity: 0.6; transition: 0.2s; }
        .mood-item:hover { opacity: 1; transform: scale(1.1); }
        .mood-item.selected { opacity: 1; border: 2px solid var(--ink); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .mood-item img { width: 100%; height: 100%; object-fit: contain; }

        /* MASCOT OVERLAY */
        .mascot-overlay { position: fixed; bottom: 30px; right: 30px; display: flex; align-items: flex-end; gap: 15px; z-index: 9999; animation: slideIn 0.3s; }
        .mascot-msg { background: var(--paper); color: var(--ink); padding: 15px; border: 2px solid var(--border); max-width: 250px; box-shadow: 5px 5px 0 rgba(0,0,0,0.2); font-weight: bold; font-size: 12px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <div id="boot-screen" class="full-screen active center-flex" style="background:#1a1a1a;">
        <img src="obunto/normal.png" width="80" style="filter:grayscale(1) contrast(1.2);">
        <div style="color:#89937a; font-weight:bold; margin-top:20px; font-size:12px;">SYSTEM_INITIALIZATION...</div>
    </div>

    <div id="login-screen" class="full-screen center-flex">
        <div class="window opening" style="width:320px;">
            <div class="win-header">SECURE_GATEWAY</div>
            <div class="win-body">
                <div id="step1">
                    <p style="font-size:11px; margin-bottom:5px;">PERSONNEL ID:</p>
                    <input type="text" id="inpId" placeholder="ENTER ID">
                    <button class="os-btn" onclick="checkId()" style="width:100%">VERIFY</button>
                </div>
                <div id="step2" class="hidden">
                    <p style="font-size:11px; margin-bottom:5px;">ACCESS CODE:</p>
                    <input type="password" id="inpPass">
                    <button class="os-btn" onclick="doLogin()" style="width:100%">LOGIN</button>
                    <div style="text-align:center; margin-top:10px; font-size:10px; text-decoration:underline; cursor:pointer;" onclick="location.reload()">CANCEL</div>
                </div>
                <div id="loginStatus" style="text-align:center; margin-top:15px; font-size:10px;">STANDING BY</div>
            </div>
        </div>
    </div>

    <div id="desktop-screen" class="full-screen">
        <div class="window opening" style="position:absolute; top:30px; left:30px; width:220px;">
            <div class="win-header">PERSONNEL_FILE</div>
            <div class="win-body" style="text-align:center;">
                <img id="userAvatar" width="80" style="border:2px solid var(--border); margin-bottom:10px;">
                <h3 id="userName" style="text-transform:uppercase;">User</h3>
                <p id="userId" style="font-size:10px; margin-top:5px;"></p>
                <p id="userRank" style="font-size:10px; margin-top:2px; font-weight:bold;"></p>
            </div>
        </div>
        <div style="position:absolute; bottom:0; left:0; width:100%; background:var(--paper); border-top:2px solid var(--border); padding:5px 10px; font-size:11px; display:flex; justify-content:space-between;">
            <span>TSC_INTRANET_v5.0</span>
            <span id="clock">00:00</span>
        </div>
    </div>

    <div id="admin-screen" class="full-screen">
        <div style="margin-bottom:10px; border-bottom:2px solid var(--border); padding-bottom:5px; display:flex; justify-content:space-between; font-weight:bold;">
            <span>COMMAND_CONTROL // OBUNTO_CORE</span>
            <div><button class="os-btn small" onclick="requestRefresh()">REFRESH_DB</button> <span id="admClock">00:00</span></div>
        </div>

        <div class="adm-container">
            <div class="adm-panel" style="grid-row: span 2;">
                <div class="adm-title">
                    <span>DATABASE (<span id="userCount">0</span>)</span>
                    <input type="text" id="searchUser" placeholder="SEARCH..." style="width:100px; margin:0; padding:0 5px; height:15px; font-size:10px; border:none;" onkeyup="filterUsers()">
                </div>
                <div class="adm-content" id="userList"></div>
            </div>

            <div class="adm-panel" style="grid-row: span 2;">
                <div class="adm-title">PERSONA_INTERFACE</div>
                <div class="adm-content">
                    <p style="font-size:10px; margin-bottom:3px;">SELECT_AVATAR:</p>
                    <div id="moodGrid" class="mood-grid">
                        </div>

                    <p style="font-size:10px; margin-bottom:3px; margin-top:10px;">TARGET:</p>
                    <select id="bcTarget">
                        <option value="all">GLOBAL_CHANNEL</option>
                    </select>
                    
                    <p style="font-size:10px; margin-bottom:3px;">MESSAGE:</p>
                    <input type="text" id="bcMsg" placeholder="TYPE MESSAGE...">
                    
                    <div style="display:flex; margin-top:10px;">
                        <button class="os-btn" onclick="sendBc('normal')" style="flex:1;">TRANSMIT</button>
                        <button class="os-btn danger" onclick="sendBc('urgent')" style="flex:1;">ALERT</button>
                    </div>
                </div>
            </div>

            <div class="adm-panel">
                <div class="adm-title">MANUAL_OVERRIDE</div>
                <div class="adm-content">
                    <p style="font-size:10px; margin-bottom:5px;">TARGET ID:</p>
                    <input type="text" id="manualId">
                    <div style="display:flex; gap:5px;">
                        <button class="os-btn danger" onclick="manualAction('delete')" style="flex:1;">DELETE</button>
                        <button class="os-btn" onclick="manualAction('freeze')" style="flex:1;">FREEZE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let isRegistering = false;
        let allUsersData = [];
        let selectedMood = 'normal';

        // --- LISTA DE ÃCONES (ADICIONE SEUS 140 NOMES AQUI) ---
        const MOOD_LIST = [
            'normal', 'happy', 'annoyed', 'sad', 'bug', 'werror', 
            'stare', 'smug', 'suspicious', 'sleeping', 'panic', 'hollow', 'dizzy'
            // Exemplo: 'angry', 'confused', 'robot', 'glitch1', 'glitch2'...
        ];

        window.onload = () => setTimeout(() => {
            document.getElementById('boot-screen').classList.remove('active');
            document.getElementById('login-screen').classList.add('active');
        }, 2000);

        // LOGIN
        async function checkId() {
            const id = document.getElementById('inpId').value.trim();
            if(!id) return;
            const res = await fetch('/api/check-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id}) });
            const data = await res.json();
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('loginStatus').innerText = data.registered ? "ENTER CODE" : "CREATE NEW CODE";
            isRegistering = !data.registered;
        }

        async function doLogin() {
            const id = document.getElementById('inpId').value.trim();
            const pass = document.getElementById('inpPass').value.trim();
            const endpoint = isRegistering ? '/api/register' : '/api/login';
            const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id, password:pass}) });
            const data = await res.json();

            if (data.success) {
                if (isRegistering) { location.reload(); return; }
                currentUser = data.userData;

                if (currentUser.isAdmin) {
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('admin-screen').classList.add('active');
                    initAdmin();
                } else {
                    document.getElementById('userAvatar').src = currentUser.avatar;
                    document.getElementById('userName').innerText = currentUser.username;
                    document.getElementById('userId').innerText = currentUser.id;
                    document.getElementById('userRank').innerText = currentUser.rank;
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('desktop-screen').classList.add('active');
                    socket.emit('user_login', currentUser);
                    initListeners();
                }
            } else if (data.message === "ID_TAKEN") { isRegistering = false; doLogin(); 
            } else { document.getElementById('loginStatus').innerText = "DENIED: " + (data.message || "ERROR"); document.getElementById('inpPass').value = ""; }
        }

        // USER
        function initListeners() {
            socket.on('receive_mascot_msg', showMascot);
            socket.on('force_disconnect', () => { alert("CONNECTION_TERMINATED"); location.reload(); });
            socket.on('account_frozen', () => { alert("ID_FROZEN"); location.reload(); });
            socket.on('account_deleted', () => { alert("ID_DELETED"); location.reload(); });
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
        }

        function showMascot(data) {
            const el = document.createElement('div');
            el.className = 'mascot-overlay';
            // Usa o mood enviado pelo admin
            el.innerHTML = `<img src="obunto/${data.mood || 'normal'}.png" width="60" style="background:#c8d1c0; border:2px solid #2b3323;">
                            <div class="mascot-msg">${data.message}</div>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 6000);
        }

        // ADMIN
        function initAdmin() {
            socket.emit('admin_login');
            socket.on('users_list', updateAdminTable);
            renderMoodGrid();
            setInterval(() => document.getElementById('admClock').innerText = new Date().toLocaleTimeString(), 1000);
        }

        function renderMoodGrid() {
            const grid = document.getElementById('moodGrid');
            grid.innerHTML = '';
            MOOD_LIST.forEach(mood => {
                const btn = document.createElement('div');
                btn.className = 'mood-item';
                if(mood === 'normal') btn.classList.add('selected');
                
                // Tenta carregar a imagem, se falhar mostra texto
                btn.innerHTML = `<img src="obunto/${mood}.png" onerror="this.style.display='none'; this.parentNode.innerText='${mood.substring(0,3)}'">`;
                
                btn.onclick = () => {
                    document.querySelectorAll('.mood-item').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedMood = mood;
                };
                grid.appendChild(btn);
            });
        }

        function requestRefresh() {
            document.getElementById('userList').innerHTML = '<div style="padding:10px;">FETCHING_DB...</div>';
            socket.emit('admin_refresh_list');
        }

        function updateAdminTable(users) {
            allUsersData = users;
            renderList(users);
        }

        function renderList(list) {
            const container = document.getElementById('userList');
            document.getElementById('userCount').innerText = list.length;
            container.innerHTML = '';
            list.forEach(u => {
                const row = document.createElement('div');
                row.className = 'user-row';
                let statusClass = u.frozen ? 'frozen' : (u.online ? 'online' : 'offline');
                row.innerHTML = `
                    <div style="flex:1;">
                        <span class="status-dot ${statusClass}"></span>
                        <b>${u.username}</b> <span style="opacity:0.6; font-size:10px;">[${u.id}]</span>
                    </div>
                    <div>
                        ${u.online ? `<button class="os-btn small" onclick="quickAction('kick', '${u.id}')">KICK</button>` : ''}
                        <button class="os-btn small" onclick="quickAction('freeze', '${u.id}')">${u.frozen ? 'UNFREEZE' : 'FREEZE'}</button>
                        <button class="os-btn small danger" onclick="quickAction('delete', '${u.id}')">DEL</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function filterUsers() {
            const term = document.getElementById('searchUser').value.toLowerCase();
            const filtered = allUsersData.filter(u => u.username.toLowerCase().includes(term) || u.id.includes(term));
            renderList(filtered);
        }

        function quickAction(action, id) {
            if(confirm(`CONFIRM: ${action.toUpperCase()} ${id}?`)) socket.emit('admin_'+action, id);
        }

        function manualAction(action) {
            const id = document.getElementById('manualId').value.trim();
            if(!id) return;
            quickAction(action, id);
        }

        function sendBc(type) {
            const msg = document.getElementById('bcMsg').value;
            if(!msg) return;
            // AGORA ENVIA O MOOD SELECIONADO
            socket.emit('admin_broadcast', { message: msg, type: type, target: 'all', mood: selectedMood });
            document.getElementById('bcMsg').value = "";
        }
    </script>
</body>
</html>