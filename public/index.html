<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEWTON OS // TSC GATEWAY</title>
    <style>
        :root { --bg: #89937a; --ink: #2b3323; --paper: #c8d1c0; --border: #2b3323; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background: #0f0f0f; height: 100vh; font-family: 'Courier New', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 9999; }
        
        .full-screen { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); position: relative; padding: 20px; }
        .full-screen.active { display: flex; }
        .center-flex { justify-content: center; align-items: center; }

        /* ESTILO NEWTON (UNIFICADO) */
        .window { background: var(--paper); border: 2px solid var(--border); box-shadow: 8px 8px 0 rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .win-header { background: var(--border); color: var(--bg); padding: 5px 10px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 2px solid var(--border); }
        .win-body { padding: 15px; overflow-y: auto; color: var(--ink); }
        
        input, select, textarea { background: transparent; border: none; border-bottom: 2px solid var(--border); width: 100%; padding: 5px; font-family: inherit; font-weight: bold; outline: none; margin-bottom: 10px; color: var(--ink); }
        
        .os-btn { background: var(--paper); border: 2px solid var(--border); padding: 8px; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 0 var(--border); color: var(--ink); margin-right: 5px; }
        .os-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 var(--border); }
        .os-btn.danger { border-color: #550000; color: #550000; }

        .hidden { display: none !important; }

        /* ADMIN PANEL - ESTILO PAPEL/RETRO (LIMPO) */
        .adm-container { display: grid; grid-template-columns: 250px 1fr 250px; grid-template-rows: 1fr 1fr; gap: 15px; height: 100%; }
        
        .adm-panel { background: var(--paper); border: 2px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .adm-title { background: var(--border); color: var(--bg); padding: 5px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .adm-content { padding: 10px; overflow-y: auto; flex: 1; font-size: 11px; }

        .user-row { padding: 5px; border-bottom: 1px dashed var(--border); cursor: pointer; display: flex; justify-content: space-between; }
        .user-row:hover, .user-row.selected { background: var(--bg); color: var(--paper); }
        .status-dot { display: inline-block; width: 6px; height: 6px; background: var(--ink); border-radius: 50%; margin-right: 5px; }

        .log-line { margin-bottom: 3px; border-bottom: 1px dotted rgba(43, 51, 35, 0.3); padding-bottom: 2px; }
        
        /* MENSAGEM DO OBUNTO */
        .mascot-overlay { position: fixed; bottom: 30px; right: 30px; display: flex; align-items: flex-end; gap: 15px; z-index: 9999; animation: slideIn 0.3s; }
        .mascot-msg { background: var(--paper); color: var(--ink); padding: 15px; border: 2px solid var(--border); max-width: 250px; box-shadow: 5px 5px 0 rgba(0,0,0,0.2); font-weight: bold; font-size: 12px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <div id="boot-screen" class="full-screen active center-flex" style="background:#1a1a1a;">
        <img src="obunto/normal.png" width="80" style="filter:grayscale(1) contrast(1.2);">
        <div style="color:#89937a; font-weight:bold; margin-top:20px; font-size:12px;">SYSTEM_INITIALIZATION...</div>
    </div>

    <div id="login-screen" class="full-screen center-flex">
        <div class="window" style="width:320px;">
            <div class="win-header">SECURE_GATEWAY</div>
            <div class="win-body">
                <div id="step1">
                    <p style="font-size:11px; margin-bottom:5px;">PERSONNEL ID:</p>
                    <input type="text" id="inpId">
                    <button class="os-btn" onclick="checkId()" style="width:100%">VERIFY</button>
                </div>
                <div id="step2" class="hidden">
                    <p style="font-size:11px; margin-bottom:5px;">ACCESS CODE:</p>
                    <input type="password" id="inpPass">
                    <button class="os-btn" onclick="doLogin()" style="width:100%">LOGIN</button>
                    <div style="text-align:center; margin-top:10px; font-size:10px; text-decoration:underline; cursor:pointer;" onclick="location.reload()">CANCEL</div>
                </div>
                <div id="loginStatus" style="text-align:center; margin-top:15px; font-size:10px;">STANDING BY</div>
            </div>
        </div>
    </div>

    <div id="desktop-screen" class="full-screen">
        <div class="window" style="position:absolute; top:30px; left:30px; width:220px;">
            <div class="win-header">PERSONNEL_FILE</div>
            <div class="win-body" style="text-align:center;">
                <img id="userAvatar" width="80" style="border:2px solid var(--border); margin-bottom:10px;">
                <h3 id="userName" style="text-transform:uppercase;">User</h3>
                <p id="userId" style="font-size:10px; margin-top:5px;"></p>
                <p id="userRank" style="font-size:10px; margin-top:2px; font-weight:bold;"></p>
            </div>
        </div>
        <div style="position:absolute; bottom:0; left:0; width:100%; background:var(--paper); border-top:2px solid var(--border); padding:5px 10px; font-size:11px; display:flex; justify-content:space-between;">
            <span>TSC_INTRANET_v5.0</span>
            <span id="clock">00:00</span>
        </div>
    </div>

    <div id="admin-screen" class="full-screen">
        <div style="margin-bottom:10px; border-bottom:2px solid var(--border); padding-bottom:5px; display:flex; justify-content:space-between; font-weight:bold;">
            <span>COMMAND_CONTROL // OBUNTO_CORE</span>
            <span id="admClock">00:00:00</span>
        </div>

        <div class="adm-container">
            <div class="adm-panel" style="grid-row: span 2;">
                <div class="adm-title">ACTIVE_PERSONNEL (<span id="userCount">0</span>)</div>
                <div class="adm-content" id="userList"></div>
            </div>

            <div class="adm-panel" style="grid-column: span 2;">
                <div class="adm-title">ACTIVITY_LOG: <span id="spyTargetName">NONE</span></div>
                <div class="adm-content" id="spyFeed" style="font-family:'Courier New'; line-height:1.4;">
                    SYSTEM_READY. WAITING_FOR_SELECTION...
                </div>
            </div>

            <div class="adm-panel">
                <div class="adm-title">ACTIONS</div>
                <div class="adm-content">
                    <button class="os-btn" onclick="admAction('kick')" style="width:100%; margin-bottom:5px;">DISCONNECT</button>
                    <button class="os-btn" onclick="admAction('freeze')" style="width:100%; margin-bottom:5px;">FREEZE_ID</button>
                    <button class="os-btn danger" onclick="admAction('delete')" style="width:100%;">DELETE_ID</button>
                </div>
            </div>

            <div class="adm-panel">
                <div class="adm-title">TRANSMISSION</div>
                <div class="adm-content">
                    <select id="bcTarget">
                        <option value="all">GLOBAL_CHANNEL</option>
                        <option value="sel">DIRECT_LINK</option>
                    </select>
                    <input type="text" id="bcMsg" placeholder="TYPE MESSAGE...">
                    <div style="display:flex;">
                        <button class="os-btn" onclick="sendBc('normal')" style="flex:1;">SEND</button>
                        <button class="os-btn danger" onclick="sendBc('urgent')" style="flex:1;">ALERT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let selectedUserId = null;
        let isRegistering = false;

        // BOOT
        window.onload = () => setTimeout(() => {
            document.getElementById('boot-screen').classList.remove('active');
            document.getElementById('login-screen').classList.add('active');
        }, 2000);

        // LOGIN CORRIGIDO (COM TRIM)
        async function checkId() {
            const id = document.getElementById('inpId').value.trim(); // <--- CORREÇÃO
            if(!id) return;
            const res = await fetch('/api/check-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id}) });
            const data = await res.json();
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('loginStatus').innerText = data.registered ? "ENTER CODE" : "CREATE NEW CODE";
            isRegistering = !data.registered;
        }

        async function doLogin() {
            const id = document.getElementById('inpId').value.trim(); // <--- CORREÇÃO
            const pass = document.getElementById('inpPass').value.trim(); // <--- CORREÇÃO
            const endpoint = isRegistering ? '/api/register' : '/api/login';

            const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id, password:pass}) });
            const data = await res.json();

            if (data.success) {
                if (isRegistering) { location.reload(); return; }
                currentUser = data.userData;

                if (currentUser.isAdmin) {
                    // ADMIN MODE (000)
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('admin-screen').classList.add('active');
                    initAdmin();
                } else {
                    // USER MODE
                    document.getElementById('userAvatar').src = currentUser.avatar;
                    document.getElementById('userName').innerText = currentUser.username;
                    document.getElementById('userId').innerText = currentUser.id;
                    document.getElementById('userRank').innerText = currentUser.rank;
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('desktop-screen').classList.add('active');
                    
                    socket.emit('user_login', currentUser);
                    initTracking();
                }
            } else if (data.message === "ID_TAKEN") {
                isRegistering = false; doLogin(); // Auto-retry login
            } else {
                document.getElementById('loginStatus').innerText = "DENIED: " + (data.message || "ERROR");
                document.getElementById('inpPass').value = "";
            }
        }

        // --- USER FUNCTIONS ---
        function initTracking() {
            ['click', 'mousemove', 'keypress'].forEach(evt => {
                document.addEventListener(evt, () => {
                    if(Math.random() < 0.05) socket.emit('activity_track', { action: evt.toUpperCase(), details: 'Active' });
                });
            });
            socket.on('receive_mascot_msg', showMascot);
            socket.on('force_disconnect', () => { alert("CONNECTION_TERMINATED"); location.reload(); });
            socket.on('account_frozen', () => { alert("ID_FROZEN"); location.reload(); });
            socket.on('account_deleted', () => { alert("ID_DELETED"); location.reload(); });
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
        }

        function showMascot(data) {
            const el = document.createElement('div');
            el.className = 'mascot-overlay';
            el.innerHTML = `<img src="obunto/${data.mood || 'normal'}.png" width="60" style="background:#c8d1c0; border:2px solid #2b3323;">
                            <div class="mascot-msg">${data.message}</div>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }

        // --- ADMIN FUNCTIONS ---
        function initAdmin() {
            socket.emit('admin_login');
            socket.on('users_list', renderUserList);
            socket.on('spy_feed', updateSpyLog);
            setInterval(() => document.getElementById('admClock').innerText = new Date().toLocaleTimeString(), 1000);
        }

        function renderUserList(users) {
            const list = document.getElementById('userList');
            document.getElementById('userCount').innerText = users.length;
            list.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = `user-row ${selectedUserId === u.id ? 'selected' : ''}`;
                div.innerHTML = `<span><span class="status-dot"></span>${u.username}</span> <span>${u.id}</span>`;
                div.onclick = () => selectUser(u);
                list.appendChild(div);
            });
        }

        function selectUser(u) {
            selectedUserId = u.id;
            document.getElementById('spyTargetName').innerText = u.username;
            document.getElementById('spyFeed').innerHTML = `<div class="log-line">LINK_ESTABLISHED: ${u.username}</div>`;
            socket.emit('admin_login'); // Refresh list UI
        }

        function updateSpyLog(data) {
            if (data.userId !== selectedUserId) return;
            const feed = document.getElementById('spyFeed');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.innerText = `[${new Date().toLocaleTimeString()}] ${data.action}`;
            feed.appendChild(line);
            feed.scrollTop = feed.scrollHeight;
        }

        function admAction(action) {
            if(!selectedUserId) return;
            if(confirm(`CONFIRM: ${action.toUpperCase()} ${selectedUserId}?`)) socket.emit('admin_'+action, selectedUserId);
        }

        function sendBc(type) {
            const msg = document.getElementById('bcMsg').value;
            if(!msg) return;
            const target = document.getElementById('bcTarget').value === 'sel' ? selectedUserId : 'all';
            socket.emit('admin_broadcast', { message: msg, type: type, mood: 'normal', target: target });
            document.getElementById('bcMsg').value = "";
        }
    </script>
</body>
</html>