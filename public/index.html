<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TSC // MAINFRAME</title>
    <style>
        :root { --bg: #89937a; --ink: #2b3323; --paper: #c8d1c0; --border: #2b3323; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background-color: #1a1a1a; height: 100vh; font-family: 'Courier New', monospace; overflow: hidden; color: var(--ink); }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.05) 50%); background-size: 100% 4px; z-index: 1000; pointer-events: none; }
        .app-container { width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        .full-screen { width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; }
        .active { display: flex; }
        .hidden { display: none !important; }
        .window { background: var(--paper); border: 2px solid var(--border); box-shadow: 6px 6px 0 rgba(0,0,0,0.2); }
        .win-header { background: var(--border); color: var(--bg); padding: 5px 10px; display: flex; justify-content: space-between; font-weight: bold; }
        .win-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        input { background: transparent; border: none; border-bottom: 2px solid var(--border); color: var(--ink); outline: none; width: 100%; padding: 5px; }
        .os-btn { background: var(--paper); border: 2px solid var(--border); padding: 8px; cursor: pointer; box-shadow: 3px 3px 0 var(--border); font-weight: bold; }
        .top-bar { height: 35px; background: var(--paper); border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-size: 12px; }
        .desktop-content { flex: 1; position: relative; padding: 20px; }
        .os-dock { height: 50px; background: var(--paper); border-top: 2px solid var(--border); display: flex; justify-content: center; align-items: center; gap: 30px; }
        .obunto-box { position: fixed; bottom: 70px; right: 20px; display: flex; align-items: flex-end; gap: 10px; z-index: 2000; }
        .obunto-avatar { width: 70px; height: 70px; background: var(--paper); border: 2px solid var(--border); padding: 5px; }
        .obunto-avatar img { width: 100%; height: 100%; object-fit: contain; }
        .obunto-speech { background: var(--border); color: var(--bg); padding: 12px; border-radius: 10px 10px 0 10px; max-width: 250px; font-size: 14px; }
        .mood-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; }
        .mood-item { border: 1px solid var(--ink); padding: 2px; cursor: pointer; text-align: center; }
        .mood-item.selected { background: var(--ink); }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="app-container">
        
        <div id="login-screen" class="full-screen active">
            <div class="window" style="width:300px; margin:auto;">
                <div class="win-header"><span>AUTHENTICATION</span></div>
                <div class="win-body">
                    <input type="text" id="inpId" placeholder="USER ID">
                    <input type="text" id="inpUser" placeholder="USERNAME">
                    <button id="btnLogin" class="os-btn">ACCESS</button>
                    <div id="loginStatus" style="text-align:center; font-size:10px;">READY</div>
                </div>
            </div>
        </div>

        <div id="desktop-screen" class="full-screen">
            <div class="top-bar"><span>TSC_INTRANET</span><span id="clock">00:00</span></div>
            <div class="desktop-content">
                <div onclick="document.getElementById('profile-window').classList.toggle('hidden')" style="cursor:pointer; width:80px; text-align:center;">
                    <img src="assets/icon-large-owner_info-28x14.png" width="40" onerror="this.src='https://via.placeholder.com/40'"><br><span style="font-size:12px;">PROFILE</span>
                </div>
                <div id="profile-window" class="window hidden" style="position:absolute; top:40px; left:40px; width:400px;">
                    <div class="win-header"><span>PERSONNEL_FILE</span><button onclick="document.getElementById('profile-window').classList.add('hidden')" style="background:none; border:none; color:inherit; cursor:pointer;">X</button></div>
                    <div class="win-body" id="profileData"></div>
                </div>
            </div>
            <div class="os-dock"><img src="assets/icon-tiny-dock-19x11.png" onclick="location.reload()" style="cursor:pointer;"></div>
        </div>

        <div id="admin-screen" class="full-screen" style="background:#2b3323; color:#89937a;">
            <div class="top-bar" style="background:transparent; color:#89937a;"><span>OBUNTO_CORE</span><button onclick="location.reload()" style="color:#89937a; background:none; border:1px solid #89937a;">EXIT</button></div>
            <div style="padding:20px;">
                <p>EMOTION:</p>
                <div id="moodGrid" class="mood-grid"></div>
                <p>SYSTEM BROADCAST:</p>
                <textarea id="adminMsg" style="height:80px; width:100%; color:#89937a; border:1px solid #89937a; background:transparent; outline:none;"></textarea>
                <button id="btnSend" class="os-btn" style="margin-top:10px; width:100%; background:#89937a; color:#2b3323;">TRANSMIT</button>
            </div>
        </div>

    </div>

    <div id="obunto-popup" class="obunto-box hidden">
        <div class="obunto-avatar"><img id="obunto-face" src="obunto/normal.png"></div>
        <div class="obunto-speech"><div id="obunto-text"></div></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const moods = ["annoyed", "bug", "dizzy", "happy", "hollow", "normal", "panic", "sad", "sleeping", "Smug", "stare", "suspicious", "werror"];
        let selMood = "normal";

        window.onload = () => {
            const grid = document.getElementById('moodGrid');
            if(grid) moods.forEach(m => {
                const d = document.createElement('div'); d.className = 'mood-item';
                d.innerHTML = `<img src="obunto/${m}.png" width="30" onerror="this.src='https://via.placeholder.com/30'">`;
                d.onclick = () => { selMood = m; document.querySelectorAll('.mood-item').forEach(i=>i.classList.remove('selected')); d.classList.add('selected'); };
                grid.appendChild(d);
            });
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        };

        document.getElementById('btnLogin').onclick = async () => {
            const id = document.getElementById('inpId').value.trim();
            const user = document.getElementById('inpUser').value.trim();
            const status = document.getElementById('loginStatus');
            status.innerText = "AUTHENTICATING...";

            try {
                const res = await fetch('/api/login', { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({userId:id, usernameInput:user}) 
                });
                const data = await res.json();
                
                if(data.success) {
                    document.getElementById('login-screen').classList.remove('active');
                    if(data.userData.id === "000") {
                        document.getElementById('admin-screen').classList.add('active');
                    } else {
                        document.getElementById('desktop-screen').classList.add('active');
                        document.getElementById('profileData').innerHTML = `
                            <div style="display:flex; gap:15px; align-items:center;">
                                <img src="${data.userData.avatar}" width="100" style="border:2px solid #2b3323;" onerror="this.src='https://via.placeholder.com/100'">
                                <div style="font-size:12px;">
                                    <p><b>IDENTITY:</b> ${data.userData.username}</p>
                                    <p><b>DEPT:</b> ${data.userData.department}</p>
                                    <p><b>RANK:</b> ${data.userData.rank}</p>
                                    <p><b>CLEARANCE:</b> LEVEL ${data.userData.clearance}</p>
                                </div>
                            </div>`;
                    }
                } else { status.innerText = "ACCESS DENIED"; }
            } catch(e) { status.innerText = "OFFLINE"; }
        };

        document.getElementById('btnSend')?.addEventListener('click', () => {
            const t = document.getElementById('adminMsg').value;
            if(t) { socket.emit('mascot_broadcast', { mood:selMood, text:t }); document.getElementById('adminMsg').value = ""; }
        });

        socket.on('receive_mascot_msg', d => {
            document.getElementById('obunto-face').src = `obunto/${d.mood}.png`;
            document.getElementById('obunto-text').innerText = d.text;
            document.getElementById('obunto-popup').classList.remove('hidden');
            setTimeout(() => document.getElementById('obunto-popup').classList.add('hidden'), 8000);
        });
    </script>
</body>
</html>