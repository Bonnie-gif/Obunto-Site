<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEWTON OS // SECURE GATEWAY</title>
    <style>
        :root { --bg: #89937a; --ink: #2b3323; --paper: #c8d1c0; --border: #2b3323; --danger: #6b2828; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { background: #0f0f0f; height: 100vh; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; color: var(--ink); overflow: hidden; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; z-index: 9999; pointer-events: none; }
        .app-container { width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        .full-screen { width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; }
        .active { display: flex; }
        .window { background: var(--paper); border: 2px solid var(--border); box-shadow: 8px 8px 0 rgba(0,0,0,0.2); transition: all 0.2s; }
        .win-header { background: var(--border); color: var(--bg); padding: 6px 10px; display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; }
        .win-body { padding: 25px; }
        input { background: transparent; border: none; border-bottom: 2px solid var(--border); color: var(--ink); outline: none; padding: 8px; width: 100%; margin-bottom: 15px; font-family: inherit; font-size: 16px; font-weight: bold; }
        .os-btn { background: var(--paper); border: 2px solid var(--border); padding: 12px; cursor: pointer; font-weight: bold; box-shadow: 4px 4px 0 var(--border); text-transform: uppercase; }
        .os-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--border); }
        .hidden { display: none !important; }

        /* NOVOS EFEITOS */
        @keyframes handwrite { from { opacity: 0; transform: translateX(-2px) translateY(1px); } to { opacity: 1; transform: translateX(0) translateY(0); } }
        input { animation: handwrite 0.1s ease-in; }
        
        @keyframes ink-spread { 0% { clip-path: circle(0% at 50% 0%); } 100% { clip-path: circle(150% at 50% 0%); } }
        .window.opening { animation: ink-spread 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* BOOT ANIMATION */
        .boot-bar-container { width: 100%; height: 20px; border: 2px solid var(--border); padding: 2px; margin-top: 10px; }
        .boot-fill { height: 100%; background: var(--ink); width: 0%; }
        
        /* OBUNTO OVERLAY */
        .obunto-overlay { position: fixed; bottom: 20px; right: 20px; display: flex; align-items: flex-end; gap: 15px; z-index: 10000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="app-container">
        <div id="boot-1" class="full-screen active" style="background:#111; justify-content:center; align-items:center;">
            <div style="text-align:center;"><img src="obunto/normal.png" width="100" style="filter:grayscale(1);"><div>INITIALIZING...</div></div>
        </div>
        <div id="boot-2" class="full-screen" style="justify-content:center; align-items:center;">
            <div class="window" style="width:300px;">
                <div class="win-header">SYSTEM_CHECK</div>
                <div class="win-body">
                    <div>> Establishing link... OK</div>
                    <div class="boot-bar-container"><div class="boot-fill" id="boot-progress"></div></div>
                </div>
            </div>
        </div>

        <div id="login-screen" class="full-screen" style="justify-content:center; align-items:center;">
            <div class="window opening" style="width:380px;">
                <div class="win-header">SECURE_ACCESS</div>
                <div class="win-body">
                    <div id="auth-step-1">
                        <p>ENTER ID:</p><input type="text" id="inpId">
                        <button id="btnCheck" class="os-btn" style="width:100%">VERIFY</button>
                    </div>
                    <div id="auth-step-2" class="hidden">
                        <p id="auth-msg">PASSWORD:</p><input type="password" id="inpPass">
                        <button id="btnFinal" class="os-btn" style="width:100%">ACCESS</button>
                    </div>
                    <div id="statusMsg" style="text-align:center; font-size:10px; margin-top:10px;">READY</div>
                </div>
            </div>
        </div>

        <div id="desktop-screen" class="full-screen">
            <div style="padding:20px;">
                <div onclick="toggleWindow('p-win')" style="cursor:pointer; width:80px; text-align:center;">
                    <img src="assets/icon-large-owner_info-28x14.png" width="45"><br><span>DOSSIER</span>
                </div>
                <div id="p-win" class="window hidden opening" style="position:absolute; top:50px; left:50px; width:600px;">
                    <div class="win-header"><span>RECORD</span><button onclick="toggleWindow('p-win')">[X]</button></div>
                    <div class="win-body" id="profileData"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentMode = 'login';
        let currentUser = null;

        // TRACKING FUNCTION
        function track(action, details='') {
            if(currentUser) socket.emit('user_activity', { action, details });
        }

        // BOOT SEQUENCE
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('boot-1').classList.remove('active');
                document.getElementById('boot-2').classList.add('active');
                let w=0, b=document.getElementById('boot-progress');
                let i=setInterval(() => { w+=5; b.style.width=w+'%'; if(w>=100) { clearInterval(i); setTimeout(() => {
                    document.getElementById('boot-2').classList.remove('active');
                    document.getElementById('login-screen').classList.add('active');
                }, 500); }}, 100);
            }, 2000);
        };

        // LOGIN LOGIC
        document.getElementById('btnCheck').onclick = async () => {
            const id = document.getElementById('inpId').value.trim();
            if(!id) return;
            document.getElementById('statusMsg').innerText = "CHECKING...";
            try {
                const res = await fetch('/api/check-user', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id}) });
                const data = await res.json();
                if(data.registered) { setupAuth('login', "ENTER PASSWORD:"); } 
                else { setupAuth('register', "CREATE PASSWORD:"); }
            } catch(e) { document.getElementById('statusMsg').innerText = "ERROR"; }
        };

        function setupAuth(mode, msg) {
            currentMode = mode;
            document.getElementById('auth-step-1').classList.add('hidden');
            document.getElementById('auth-step-2').classList.remove('hidden');
            document.getElementById('auth-msg').innerText = msg;
        }

        document.getElementById('btnFinal').onclick = async () => {
            const id = document.getElementById('inpId').value.trim();
            const pass = document.getElementById('inpPass').value.trim();
            const endpoint = currentMode === 'register' ? '/api/register' : '/api/login';
            
            try {
                const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:id, password:pass}) });
                const data = await res.json();
                
                if(data.success) {
                    if(currentMode === 'register') { alert("REGISTERED!"); location.reload(); }
                    else {
                        currentUser = data.userData;
                        document.getElementById('login-screen').classList.remove('active');
                        document.getElementById('desktop-screen').classList.add('active');
                        renderProfile(data.userData);
                        socket.emit('user_connected', data.userData);
                        track('LOGIN', 'User logged in');
                    }
                } else if (data.message === "ID_TAKEN") {
                     // Auto-login fallback
                     setupAuth('login', "EXISTS. LOGGING IN...");
                     document.getElementById('btnFinal').click();
                } else {
                    document.getElementById('statusMsg').innerText = "DENIED";
                }
            } catch(e) { console.log(e); }
        };

        function renderProfile(u) {
            document.getElementById('profileData').innerHTML = `<img src="${u.avatar}" width="100"> <h2>${u.username}</h2> <p>${u.id}</p>`;
        }

        function toggleWindow(id) {
            const el = document.getElementById(id);
            const isClosed = el.classList.contains('hidden');
            el.classList.toggle('hidden');
            track(isClosed ? 'OPEN_WINDOW' : 'CLOSE_WINDOW', id);
        }

        // LISTENERS
        document.addEventListener('click', (e) => { if(e.target.tagName==='BUTTON') track('CLICK', e.target.innerText); });
        document.addEventListener('input', (e) => { if(e.target.tagName==='INPUT') track('TYPE', e.target.id); });

        socket.on('receive_mascot_msg', (data) => {
            const div = document.createElement('div');
            div.className = 'obunto-overlay';
            div.innerHTML = `<img src="obunto/${data.mood}.png" style="background:#c8d1c0; border:2px solid #2b3323; width:80px;">
                             <div style="background:#2b3323; color:#c8d1c0; padding:15px; border-radius:10px 10px 0 10px;">${data.message}</div>`;
            if(data.type === 'glitch') div.style.animation = 'glitch 0.3s infinite';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 6000);
        });

        socket.on('force_disconnect', () => { alert("CONNECTION TERMINATED"); location.reload(); });
        socket.on('account_frozen', () => { alert("ACCOUNT FROZEN"); location.reload(); });
        socket.on('account_deleted', () => { alert("ACCOUNT DELETED"); location.reload(); });
    </script>
</body>
</html>